#!/sbin/openrc-run

name=$RC_SVCNAME
description="signageOS client"
pidfile="/run/$name.pid"
command="/usr/bin/node"
command_args="/usr/share/signageos/server/server.js"
command_user="signageos"
command_group="signageos"
stopsig=TERM

extra_started_commands="reload_storage_units"

env_fs_root_path=/var/lib/signageos/fs
env_fs_system_path=/var/lib/signageos/system
env_fs_app_files_path=/usr/share/signageos

servlet_pid_files_path=/var/run/signageos/servlets

depend() {
    need localmount loopback
    use udev logger
}

reload_storage_units() {
    pid=`cat $pidfile`
    if [ -n "$pid" ]; then
        kill -USR2 $pid
        eend $? "failed to reload storage units"
    else
        eend 1 "pidfile not found"
    fi
}

_ensure_pidfiles_path() {
    mkdir -p "$servlet_pid_files_path"
    chown $command_user:$command_group "$servlet_pid_files_path"
}

_stop_all_servlets() {
    # attempt to gracefully stop servlets, sigkill after 5s
    for pidfile in `ls "$servlet_pid_files_path"`; do
        pidfile_path="$servlet_pid_files_path/$pidfile"
        start-stop-daemon --stop --pidfile "$pidfile_path" --signal TERM --retry 5
    done
    # finally remove entire servlet directory
    rm -rf "$servlet_pid_files_path"
}

start() {
    ebegin "starting signageOS server"
    _ensure_pidfiles_path
    start-stop-daemon --start \
        --pidfile $pidfile \
        --make-pidfile \
        --user $command_user \
        --group $command_group \
        --env fs_root_path=$env_fs_root_path \
        --env fs_system_path=$env_fs_system_path \
        --env fs_app_files_path=$env_fs_app_files_path \
        --env servlet_pid_files_path=$servlet_pid_files_path \
        --stdout-logger "/bin/sh -c '/usr/bin/logger --tag $name -p local0.info'" \
        --stderr-logger "/bin/sh -c '/usr/bin/logger --tag $name -p local0.err'" \
        --background \
        $command -- $command_args
    eend $? "failed to start signageOS server"
}

stop() {
    ebegin "stopping signageOS server"
    start-stop-daemon --stop \
        --pidfile $pidfile \
        --signal $stopsig \
        --retry 10
    _stop_all_servlets
    eend $? "failed to stop signageOS server"
}
